<html>

  <head>

    <title>Battle | Ship</title>
    <style type="text/css">BODY {background-image: url(background.gif);}</style>
    <link href="css/main.css" type="text/css" rel="stylesheet"></link>
    <link href="css/font-awesome.min.css" type="text/css" rel="stylesheet"></link>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript" src="js/underscore.min.js"></script>

  </head>

  <body>

    <div id="startup">

      <button id="start_button">

        <i class="fa fa-bolt pull-left"></i>

          START

      </button>

      <div id="game_options">

        <select></select>

        <br/>

        <a href="#" class="btn submit">

          SUBMIT

        </a>

      </div>

    </div>

    <div id="grid">
      
      <div id="user_side" class="user-side">

        <h1>

            You

        </h1>

      </div>

      <div id="machine_side" class="machine-side">

        <h1>

          The Machine

        </h1>

      </div>

        <div id="machine_firing_button">

          <button id="machine_fire">MACHINE FIRE</button>

        </div>

      
        <!--Refactor-->

        <script type="text/javascript">
          $(document).ready(function(event){
            var game_options;

            $("#start_button").click(function(event){
              game_options = {

                difficulty_selections: {
                  easy: {
                    title:"Easy",
                    grid_size: 5
                  },

                  medium: {
                    title: "Medium",
                    grid_size: 15
                  },

                  hard: {
                    title: "Hard",
                    grid_size: 20
                  },

                  impossible: {
                    title:"Impossible",
                    grid_size: 30
                  },
                },

                forKeyString: function(key_string) {
                  difficulty_selection_keys = Object.keys(this.difficulty_selections);

                  selected_option = _.filter(difficulty_selection_keys, function(key) {
                    return(key == key_string);
                  });

                  return(this.difficulty_selections[selected_option])
                }
              }

              $.each(game_options.difficulty_selections, function(key, value){
                option = $("<option/>")
                option.val(key)
                option.text(value.title)

                //need to find out how to append data in function above so I can append data-size = value.grid_size for machine_logic

                $("#game_options select").append(option)
                $("#game_options").fadeIn();

                //additions

                $("#start_button").fadeOut();



              })

            })

            game_handlers = (function(){$(".grid-cell").click(function(event){
              var x = $(this).data("x");
              var y = $(this).data("y");
              var total_possible_hits = machine_ship.size;


              match = _.find(machine_ship.cells, function(cell){
                return($(cell).data("x") == x && $(cell).data("y") == y);
              })


              if($(this).hasClass("user-grid-cell")==true) {
                alert('wrong board, dummy')

              } else if($(this).hasClass("hit-cell")) {
                alert('you already fired there, moron');

              } else if(_.isUndefined(match)) {
                alert('miss!')

              } else {
                alert('hit!')
                machine_ship.add_hit_cell(match)
                $(this).addClass('hit-cell')
                $(this).css('background', 'red')
              }

              // if(total_possible_hits == machine_ship.hit_cells.length) {
              //   alert('YOU SANK THE SHIP!')
              //   $()

                // TODO: expand for more ship = something like sunk_machine_ships.add_sunk_ship(match something unique like name from each ship)
              // }

            })
            })

            
        

            //testing machine firing logic
  
            $("#machine_fire").click(function(event){

              // var first_user_cell_x = first_cell.data("x");
              // var first_user_cell_y = first_cell.data("y");

              // var last_user_cell_x = last_cell.data("x");
              // var last_user_cell_y = last_cell.data("y");

              // var x_guess = _.random(first_user_cell_x, last_user_cell_x);
              // var y_guess = _.random(first_user_cell_y, last_user_cell_y);

              // var match = find_cell_at(x_guess, y_guess, 'user');

              // var xy_guess = _.random(all_user_cells[0], all_user_cells.length);

              // var match = find_cell_at(x_guess, y_guess, 'user');

              // check if match has already been selected

              // var already_selected = _.filter(all_user_cells, function(cell){
              //   return(cell.data("x") == x_guess && cell.data("y") == y_guess)
              // })

              // if ( _.isUndefined(already_selected) ) {


              var first_cell = all_user_cells[0];
              var last_cell_finder = all_user_cells.length - 1;
              var last_cell = all_user_cells[last_cell_finder];

              var random_cell_selector = _.random(0, last_cell_finder);
              var cell_selected_div = all_user_cells[random_cell_selector];

              var cell_selected_x = cell_selected_div.data("x");
              var cell_selected_y = cell_selected_div.data("y");

              var match = find_cell_at(cell_selected_x, cell_selected_y, 'user');

              var index = match;
              all_user_cells.splice(index, 1);

              // } else {
              //   machine_fire();
                //if already_selected comes back as undefined, then it is a Unique hit, and we will allow it to pass. Otherwise, we will run machine_logic() again to find a unique cell target. Need to move ifElse below up
              // }

              if($(match).hasClass("user-ship-cell")) {
                alert("The Machine hit your ship")
                $(match).addClass('hit-cell')
                $(match).css('background', 'red')
                past_hits.push(match);

              } else {
                alert("The Machine hit your ship at = ")
                $(match).addClass('hit-cell')
                $(match).css('background', 'red')
                past_hits.push(match);

              }

            })

            //additions
            $( "#game_options .submit" ).click(function( event ) {
              var selectedOption = $( "option:selected" ).val();
              var selected_difficulty = game_options.forKeyString(selectedOption);
              var size = selected_difficulty.grid_size;
              grid_size = size;

              start(size);
              $("#game_options").fadeOut();
              $("#machine_fire").fadeIn();

              game_handlers();
            })

          });

        </script>

    </div>

  </body>

</html>